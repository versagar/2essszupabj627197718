<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schedule Booking</title>
    <link rel="stylesheet" href="/b1eaut2yofp1hys4er9/lib.css">
   <script src="/1san9cha1la7k9/efahfcfcfabe.js"></script>
  <script src="/1san9cha1la7k9/dgfbbhhfcfcfabe.js"></script>
  <script  src="/1san9cha1la7k9/dbhhfcfcfabe.js"></script>
</head>
<body class="ov-hidden">
<div id="test">Current Date Time: </div>
<div class="pop-overlay" id="overlayId"></div>
<div class="pop-show" id="popId"></div>
<section class="form-section" id="loginSection">
    <div class="col2 pad1 bg-info pw80 center round2 ov-hidden">
        <form id="loginForm">
<input type="text" name="id" placeholder="Student Id">
<input type="password" name="pass" placeholder="Password">
<input type="button" onclick="getBatches()" value="Submit" class="btn bg-primary text-secondary bold">
        </form>
    </div>
</section>

<section id="scheduleSetting" class="bg-secondary pad3">
    
    <form id="selectedDates" class="flex-wrap hidden">
      <!-- <p><strong>Selected Dates: </strong>Click on the selected dates to remove</p> -->
      <button type="button" class="pad3 shadow2 round2 left pw45 text-center btn bg-primary text-light bold" id="dateSubmitBtn" value="1 July 2000">Submit Dates >></button>
      <button type="button" class="pad3 shadow2 round2 left pw45 text-center btn bg-primary text-light bold" 
        id="hideDetailsBtn" 
        onclick="displayBlock('batchSummary','block', 'textContent', 'hideDetailsBtn','Hide Batch Details', 'Show Batch Details')" value="1 July 3000">Hide Batch Details</button>

    </form>
    <details class="custom-details" id="batchDetails">
  <summary id="batchSummary" class="pad2 round3 shadow2 bg-light text-primary text2">Batch List</summary>
  <div id="scheduleBox" class="table-box"></div>
</details>
    <div id="dateList" class="pad1 bg-info round2 hidden">Select the following green (available) dates, just by clicking</div>
  </section>

  <script>

  let nDates = 0;

  const testData = "APM MR O1 SON5,Monday,Sat Dec 30 1899 16:00:00 GMT+0521 (India Standard Time),,Phy AP O2 SON1,Monday,Sat Dec 30 1899 04:00:00 GMT+0521 (India Standard Time),Sun Aug 24 2025 00:00:00 GMT+0530 (India Standard Time),Phy AP P4 SON10,,Sat Dec 30 1899 14:00:00 GMT+0521 (India Standard Time),,STN MR O5 SOF5,Wednesday,Sat Dec 30 1899 04:00:00 GMT+0521 (India Standard Time),";
  const testDiv = document.getElementById('test');
  const batchSummary = document.getElementById('batchSummary');
  const batchDetails = document.getElementById('batchDetails');
  const scheduleSetting = document.getElementById('scheduleSetting');
  const dateList = document.getElementById('dateList');
  const loginUrl = "https://script.google.com/macros/s/AKfycbwtFzwfutc_OUQ3y_lt6oY8FiQBvd-tQnBlaKFIAHBUBgnMGohq3nB3FxiD1ntW3bxA/exec"
var timezone = ' (UTC+05:30) Indian Standard Time (IST), Sri Lanka Standard Time (SLST) ';
var timeZoneUTC = timezone.split("UTC")[1].split(")")[0];


  // ✅ Add locale options globally
  const localeOptions = {
    timeZone: timeZoneUTC,
  hour12: true
  };
  const nowIn = new Intl.DateTimeFormat('en-US', {
  timeZone: 'Asia/Kolkata',
  dateStyle: 'long',
  timeStyle: 'short'
}).format(new Date());
nowIn.setHours('03','00');
  testDiv.textContent = nowIn;
  async function testBatches(){
    displayItem('loginSection',0);
    batchSummary.innerHTML = "<h3 class='text-success'>Success! Loading Batch Details..</h3>";
      const data = testData;
      //document.getElementById('loginSection').innerHTML = `<h1 class='text-primary'>${name?name:"Error Loading Student Name"}</h1>`;
     await createWeekSchedule('scheduleBox', convertTo2D(data, 4, ","));
  }
  testBatches();
    async function getBatches() {
    batchSummary.textContent = "Checking credentials.."
    try {
      const response = await fetch(loginUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: new URLSearchParams({
          function: 'getBatches'
        })
      });

      if (!response.ok) {
        batchSummary.innerHTML = "<h3 class='text-danger'>Failed! Error Getting Details</h3>";
      }

      batchSummary.innerHTML = "<h3 class='text-success'>Success! Loading Batch Details..</h3>";
      const data = await response.text();
      testDiv.textContent =  data;
      document.getElementById('loginSection').innerHTML = `<h1 class='text-primary'>${name?name:"Error Loading Student Name"}</h1>`;
      createWeekSchedule('scheduleBox', convertTo2D(data, 4, ","));

    } catch (error) {
      batchSummary.innerHTML = error + "<h3 class='text-danger'>Failed! Error Getting Details</h3>";
      console.log(error);
    }
  }

  async function getDates(batchName, lastDate, batchTime) {
    batchSummary.textContent = "Finding Details ..";
    document.getElementById('loginSection').style.display = 'none';
    try {
      const response = await fetch(loginUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: new URLSearchParams({
          function: 'getDates',
          batchName: batchName
        })
      });

      batchSummary.textContent = "Finding Details .......";
      const batchCreators = batchName.split(" ");
      const batchSize = batchCreators[3].substring(3);
      const batchStatus = batchCreators[2].slice(0,1);
      const batchLocation = batchCreators[0];
      const dates = await response.text();
      batchDetails.open = false;

      // ✅ Use toLocaleString with timezone
      batchSummary.innerHTML =  "Batch Name: <span class='text-success'>"+ batchName + "</span> <span class='text-danger'>|</span> " +
        "Batch Size: <span class='text-success'>"+ batchSize + "</span> <span class='text-danger'>|</span> " +
        "Batch Time: <span class='text-success'>"+ batchTime + "</span> <span class='text-danger'>|</span> " +
        "Batch Ending on: <span class='text-danger'>"+ new Date(lastDate).toLocaleString('en-US', localeOptions) + "</span> <span class='text-danger'>|</span> " +
        "Batch Type: <span class='text-success'>"+ (batchStatus=="P"?"For You":"Open Batch") + "</span> <span class='text-danger'>|</span> " +
        "Batch Identifier: <span class='text-success'>"+ batchLocation + "</span> <span class='text-danger'>|</span> ";

      const datesData = dates.split(",");
      returnDateList(datesData, lastDate);

    } catch (error) {
      dateList.innerHTML = error;
    }
  }

function getIndianDate(date = new Date()) {
  return new Intl.DateTimeFormat('en-CA', {
    timeZone: 'Asia/Kolkata', // IST
    year: 'numeric',
    month: '2-digit',
    day: '2-digit'
  }).format(date); // returns YYYY-MM-DD
}

  
  function returnDateList(dateData, lastDate) {
    const mondayDate = getMonday(new Date());
    const lastDateObj = new Date(lastDate);
    for (let i = 0; i < dateData.length; i++) {
      const list = document.createElement('div');
      const date = new Date(mondayDate);
      date.setDate(mondayDate.getDate() + i);

      // ✅ Use toLocaleString
      const formatted = date.toLocaleString('en-US', localeOptions);
      const isActive = dateData[i] === "1" && (lastDate ? isBeforeDateOnly(date, lastDateObj) : true);

      list.textContent = formatted;
      list.className = `pad2 round2 mar3 pw80 text-center ${isActive ? "btn bg-success text-primary" : "bg-danger text-info"}`;
      list.onclick = () => {
        if (isActive) {
          selectMe(list);
        } else {
          popshow("Not available on this date - the batch is either full or closed, please select another day or another batch", 'popId', 'overlayId');
        }
      };
      document.getElementById('selectedDates').style.display = 'flex';
      dateList.style.display = 'inherit';
      dateList.appendChild(list);
    }
  }

function createWeekSchedule(id, batchData) {
  const timezone = timeZoneUTC;
  batchDetails.open = true;
  const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];

  const scheduleTable = document.createElement("table");
  scheduleTable.id = "batchListTable";
  const scheduleHead = scheduleTable.createTHead().insertRow();
  const scheduleBody = scheduleTable.createTBody();
  const timeMap = new Map();

  const today = new Date(); // Use current date for timezone accuracy
  const baseYear = today.getFullYear();
  const baseMonth = today.getMonth();
  const baseDate = today.getDate();

  batchData.forEach(row => {
    const batchName = row[0];
    const day = row[1];
    const timeStr = row[2];
    const lastDate = row[3];

    batchSummary.innerHTML = "<h3 class='text-success'>Success! Loading Batch Details...</h3>";

    if (day && timeStr && batchName) {
      const match = timeStr.match(/\d{2}:\d{2}:\d{2}/);
      if (match) {
        const [h, m] = match[0].split(":");
        const batchTime = new Date(Date.UTC(baseYear, baseMonth, baseDate, +h, +m));
        const timeKey = batchTime.toLocaleTimeString('en-US', {
          hour: '2-digit',
          minute: '2-digit',
          timeZone: timezone,
          hour12: false
        });

        if (!timeMap.has(timeKey)) timeMap.set(timeKey, {});
        if (!timeMap.get(timeKey)[day]) timeMap.get(timeKey)[day] = [];
        timeMap.get(timeKey)[day].push({ batchName, lastDate });
      }
    }
  });

  scheduleHead.insertCell().innerHTML = "Time";
  days.forEach(day => scheduleHead.insertCell().textContent = day);

  batchSummary.innerHTML = "<h3 class='text-success'>Success! Loading Batch Details....</h3>";

  for (let i = 0; i <= 47; i++) {
    const baseTime = new Date(Date.UTC(baseYear, baseMonth, baseDate, 3, 0)); // Start at 03:00 UTC
    baseTime.setHours(baseTime.getHours() + Math.floor(i / 2));
    baseTime.setMinutes((i % 2 === 0) ? 0 : 30);

    const formattedTime = baseTime.toLocaleTimeString('en-US', {
      hour: '2-digit',
      minute: '2-digit',
      timeZone: timezone,
      hour12: false
    });

    const scheduleRow = scheduleBody.insertRow();
    scheduleRow.insertCell().textContent = formattedTime;

    const dayMap = timeMap.get(formattedTime) || {};

    days.forEach(day => {
      const cell = scheduleRow.insertCell();
      const batches = dayMap[day];
      if (batches && batches.length) {
        cell.innerHTML = batches.map(batch => `
          <div 
            class="btn bg-primary mar2 text-secondary text-center shadow2 pad3 round3"
            data-last-date="${batch.lastDate}"
            data-batch-time="${formattedTime}"
            onclick="selectBatch(this)"
          >
            ${batch.batchName}
          </div>
        `).join('');
      }
    });
  }

  batchSummary.innerHTML = "<h3 class='text-success'>Success! Select Your Batch</h3>";
  document.getElementById(id).appendChild(scheduleTable);
}

   async function selectBatch(item) {
    await getDates(
      item.innerText,
      item.dataset.lastDate,
      item.dataset.batchTime
    );
  }

</script>

</body>
</html>