<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schedule Booking</title>
    <link rel="stylesheet" href="/b1eaut2yofp1hys4er9/lib.css">
   <script src="/1san9cha1la7k9/efahfcfcfabe.js"></script>
  <script src="/1san9cha1la7k9/dgfbbhhfcfcfabe.js"></script>
  <script  src="/1san9cha1la7k9/dbhhfcfcfabe.js"></script>
</head>
<body class="ov-hidden">

<div class="pop-overlay" id="overlayId"></div>
<div class="pop-show" id="popId"></div>
<section class="form-section" id="loginSection">
    <div class="col2 pad1 bg-info pw80 center round2 ov-hidden">
        <form id="loginForm">
<input type="text" name="id" placeholder="Student Id">
<input type="password" name="pass" placeholder="Password">
<input type="button" onclick="getBatches()" value="Submit" class="btn bg-primary text-secondary bold">
        </form>
    </div>
</section>

<section id="scheduleSetting" class="bg-secondary pad3">
    
    <form id="selectedDates" class="flex-wrap hidden">
      <!-- <p><strong>Selected Dates: </strong>Click on the selected dates to remove</p> -->
      <button type="button" class="pad3 shadow2 round2 left pw45 text-center btn bg-primary text-light bold" id="dateSubmitBtn" value="1 July 2000">Submit Dates >></button>
      <button type="button" class="pad3 shadow2 round2 left pw45 text-center btn bg-primary text-light bold" 
        id="hideDetailsBtn" 
        onclick="displayBlock('batchSummary','block', 'textContent', 'hideDetailsBtn','Hide Batch Details', 'Show Batch Details')" value="1 July 3000">Hide Batch Details</button>

    </form>
    <details class="custom-details" id="batchDetails">
  <summary id="batchSummary" class="pad2 round3 shadow2 bg-light text-primary text2">Batch List</summary>
  <div id="scheduleBox" class="table-box"></div>
</details>
    <div id="dateList" class="pad1 bg-info round2 hidden">Select the following green (available) dates, just by clicking</div>
  </section>
<script>
  let nDates = 0;
    const batchSummary = document.getElementById('batchSummary');
    const batchDetails =  document.getElementById('batchDetails');
    const scheduleSetting = document.getElementById('scheduleSetting');
    const dateList = document.getElementById('dateList');
    const loginUrl = "URL";

var timezone = ' (UTC+05:30) df';
var timeZoneUTC = timezone.split("UTC")[1].split(")")[0];
  const localeOptions = {
    timeZone: timezoneUTC, // Set the timezone dynamically
  year: 'numeric',
  month: 'long',
  day: 'numeric',
  hour: 'numeric',
  minute: 'numeric',
  second: 'numeric',
  hour12: true
  };
    document.getElementById('test').textContent = new Date().toLocaleDateString('en-US',localeOptions);

async function getBatches() {
  batchSummary.textContent = "Checking credentials.."
        try {
            const response = await fetch(loginUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: new URLSearchParams({
                    function: 'getBatches'
                })
            });

             if (!response.ok) {
            batchSummary.innerHTML = "<h3 class='text-danger'>Failed! Error Getting Details</h3>";
        }
        
            
            batchSummary.innerHTML = "<h3 class='text-success'>Success! Loading Batch Details..</h3>";
            const data = await response.text();
            document.getElementById('loginSection').innerHTML = `<h1 class='text-primary'>${name?name:"Error Loading Student Name"}</h1>`;
            createWeekSchedule('scheduleBox',convertTo2D(data,4,","));

        } catch (error) {
           batchSummary.innerHTML = error + "<h3 class='text-danger'>Failed! Error Getting Details</h3>";
           console.log(error);
        }
        
    }

async function getDates(batchName,lastDate,batchTime) {
  batchSummary.textContent = "Finding Details ..";
  document.getElementById('loginSection').style.display = 'none';
        try {
            const response = await fetch(loginUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: new URLSearchParams({
                    function: 'getDates',
                    batchName: batchName
                })
            });

            batchSummary.textContent = "Finding Details .......";
            const batchCreators = batchName.split(" ");
            const  batchSize = batchCreators[3].substring(3);
            const batchStatus = batchCreators[2].slice(0,1);
            const batchLocation = batchCreators[0];
            const dates = await response.text();
            batchDetails.open = false;
            batchSummary.innerHTML =  "Batch Name: <span class='text-success'>"+ batchName + "</span> <span class='text-danger'>|</span> " +
                                      "Batch Size: <span class='text-success'>"+ batchSize + "</span> <span class='text-danger'>|</span> " +
                                      "Batch Time: <span class='text-success'>"+ batchTime + "</span> <span class='text-danger'>|</span> " +
                                      "Batch Ending on: <span class='text-danger'>"+ new Date(lastDate).toLocaleDateString() + "</span> <span class='text-danger'>|</span> " +
                                      "Batch Type: <span class='text-success'>"+ (batchStatus=="P"?"For You":"Open Batch") + "</span> <span class='text-danger'>|</span> " +
                                      "Batch Identifier: <span class='text-success'>"+ batchLocation + "</span> <span class='text-danger'>|</span> ";
                                      
                                      
            const datesData = dates.split(",");        
returnDateList(datesData,lastDate);
//makeDraggable(batchSummary);

        } catch (error) {
            dateList.innerHTML = error;
        }
    }


function updateSubmitDateBtn(){
document.getElementById('dateSubmitBtn').style.display = nDates > 0 ? 'block' : 'none';
document.getElementById('dateSubmitBtn').textContent = `Submit ${nDates + (nDates>1?" Dates":" Date")} >>`
}
updateSubmitDateBtn();
function selectMe(item) {
        if(nDates>=10){
            return popshow("You can select a maximum of 10 dates at once","popId","overlayId");
        }
nDates++;
updateSubmitDateBtn();     
        const selectedId = item.textContent.trim();
document.getElementById('selectedDates').innerHTML += `<input class="pad3 shadow2 round2 left pw45 text-center btn bg-info text-primary border-solid border-primary" onclick="deselectMe('${selectedId}')" id="${selectedId}" name="${"scheduleDate"+nDates}" value="${item.textContent}">`;
item.style.display = 'none';
sortChildDivsByDate('selectedDates');
sortChildDivsByDate('dateList');
    }

function deselectMe(id){
    nDates--;
    updateSubmitDateBtn();
    const inputDate = document.getElementById(id);
    const item = document.createElement('div');
    item.textContent = inputDate.value;
    item.className = "pad2 round2 mar3 pw80 text-center btn bg-success text-primary";
    item.onclick = () => selectMe(item);
    dateList.appendChild(item);
    inputDate.remove();
    sortChildDivsByDate('selectedDates');
sortChildDivsByDate('dateList');
   }


function returnDateList(dateData, lastDate) {
  const timezone = timeZoneUTC; // Make sure this is globally defined
  const mondayIST = getMondayIST(); // Helper to get Monday in IST
  const lastDateIST = lastDate ? new Date(lastDate) : null;

  for (let i = 0; i < dateData.length; i++) {
    const list = document.createElement('div');

    // Create current date in IST
    const istDate = new Date(mondayIST);
    istDate.setDate(mondayIST.getDate() + i);

    // Convert IST date to UTC
    istDate.setUTCMinutes(istDate.getUTCMinutes() - 330); // IST offset

    // Convert to local time using user's timezone
    const localDate = new Date(istDate.toLocaleString('en-US', { timeZone: timezone }));

    // Format for display
    const formatted = localDate.toLocaleDateString('en-US', localeOptions);

    // Check if available and within range
    const isActive = dateData[i] === "1" &&
      (!lastDateIST || isBeforeDateOnlyIST(istDate, lastDateIST));

    // Create UI
    list.textContent = formatted;
    list.className = `pad2 round2 mar3 pw80 text-center ${isActive ? "btn bg-success text-primary" : "bg-danger text-info"}`;
    list.onclick = () => {
      if (isActive) {
        selectMe(list);
      } else {
        popshow("Not available on this date - the batch is either full or closed, please select another day or another batch", 'popId', 'overlayId');
      }
    };

    document.getElementById('selectedDates').style.display = 'flex';
    dateList.style.display = 'inherit';
    dateList.appendChild(list);
  }

  // Helper: Get current week's Monday in IST
  function getMondayIST() {
    const now = new Date();
    const istNow = new Date(now.toLocaleString("en-US", { timeZone: "Asia/Kolkata" }));
    const day = istNow.getDay();
    const diff = (day + 6) % 7; // Convert Sunday (0) to end
    istNow.setDate(istNow.getDate() - diff);
    return istNow;
  }

  // Helper: Check date-only comparison (ignores time)
  function isBeforeDateOnlyIST(d1, d2) {
    return (
      d1.getUTCFullYear() < d2.getUTCFullYear() ||
      (d1.getUTCFullYear() === d2.getUTCFullYear() && d1.getUTCMonth() < d2.getUTCMonth()) ||
      (d1.getUTCFullYear() === d2.getUTCFullYear() &&
        d1.getUTCMonth() === d2.getUTCMonth() &&
        d1.getUTCDate() <= d2.getUTCDate())
    );
  }
}


function createWeekSchedule(id, batchData) {
  const timezone = timeZoneUTC;
  batchDetails.open = true;

  const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
  const scheduleTable = document.createElement("table");
  scheduleTable.id = "batchListTable";

  const scheduleHead = scheduleTable.createTHead().insertRow();
  const scheduleBody = scheduleTable.createTBody();
  const timeMap = new Map();

  const today = new Date();
  const year = today.getFullYear();
  const month = today.getMonth();
  const date = today.getDate();

  // 3:00 AM IST today in UTC
  const istStart = new Date(Date.UTC(year, month, date, 3, 0));
  istStart.setUTCMinutes(istStart.getUTCMinutes() - 330); // IST offset

  // Build 48 half-hour slots from 3 AM IST
  for (let i = 0; i < 48; i++) {
    const slotUTC = new Date(istStart.getTime() + i * 30 * 60 * 1000);
    const localDate = new Date(slotUTC.toLocaleString("en-US", { timeZone: timezone }));

    const localDayIndex = localDate.getDay(); // 0 = Sunday
    const localDay = days[(localDayIndex + 6) % 7]; // Adjust Sunday (0) to end

    const hour = localDate.getHours();
    const minute = localDate.getMinutes();
    const timeKey = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;

    if (!timeMap.has(timeKey)) timeMap.set(timeKey, {});
    if (!timeMap.get(timeKey)[localDay]) timeMap.get(timeKey)[localDay] = [];

    // Store for structure only; batches will be added next
  }

  // Process each batch (assumes time is in IST and day is the IST weekday)
  batchData.forEach(row => {
    const batchName = row[0];
    const istDay = row[1];
    const timeStr = row[2];

    if (!batchName || !istDay || !timeStr) return;

    const match = timeStr.match(/\d{2}:\d{2}:\d{2}/);
    if (!match) return;

    const [h, m, s] = match[0].split(":").map(Number);
    const istDayIndex = days.indexOf(istDay); // 0-based Monday = 0

    // Create IST date for that weekday this week
    const now = new Date();
    const currentIST = new Date(now.toLocaleString("en-US", { timeZone: "Asia/Kolkata" }));
    const todayIndex = currentIST.getDay(); // 0 = Sunday
    const offset = (istDayIndex + 1 - (todayIndex === 0 ? 7 : todayIndex) + 7) % 7;

    const batchISTDate = new Date(Date.UTC(year, month, date + offset, h, m, s));
    batchISTDate.setUTCMinutes(batchISTDate.getUTCMinutes() - 330); // Convert to UTC

    // Convert to local time
    const localDate = new Date(batchISTDate.toLocaleString("en-US", { timeZone: timezone }));
    const localDayIndex = localDate.getDay();
    const localDay = days[(localDayIndex + 6) % 7];

    const hour = localDate.getHours();
    const minute = localDate.getMinutes();
    const timeKey = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;


    if (!timeMap.has(timeKey)) timeMap.set(timeKey, {});
    if (!timeMap.get(timeKey)[localDay]) timeMap.get(timeKey)[localDay] = [];

    const formattedTime = localDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

    timeMap.get(timeKey)[localDay].push({
      batchName,
      timeLabel: formattedTime
    });
  });

  // Build table header
  scheduleHead.insertCell().innerText = "Time";
  days.forEach(day => scheduleHead.insertCell().innerText = day);

  // Build table rows
  for (const [timeKey, dayMap] of timeMap.entries()) {
    const row = scheduleBody.insertRow();
    const [hourStr, minuteStr] = timeKey.split(":");
const timeDate = new Date();
timeDate.setHours(+hourStr, +minuteStr);
const amPmTime = timeDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: true });

row.insertCell().textContent = amPmTime;


    days.forEach(day => {
      const cell = row.insertCell();
      const batches = dayMap[day];

      if (batches && batches.length) {
        cell.innerHTML = batches.map(batch => `
          <div 
            class="btn bg-primary mar2 text-secondary text-center shadow2 pad3 round3"
            data-batch-time="${batch.timeLabel}"
            onclick="selectBatch(this)"
          >
            ${batch.batchName}
          </div>
        `).join('');
      }
    });
  }

  document.getElementById(id).appendChild(scheduleTable);
  batchSummary.innerHTML = "<h3 class='text-success'>Success! Select Your Batch</h3>";
}

async function selectBatch(item){
  await getDates(item.innerText,item.dataset.lastDate,item.dataset.batchTime);
}

</script>

</body>
</html>